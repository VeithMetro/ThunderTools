name: Generate Thunder plugin skeletons

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - "PluginSkeletonGenerator/**"
      - ".github/workflows/generate-plugin-skeletons.yml"
  pull_request:
    branches: [ master ]
    paths:
      - "PluginSkeletonGenerator/**"
      - ".github/workflows/generate-plugin-skeletons.yml"

# Needed for pushing to gh-pages + PR comments
permissions:
  contents: write
  pull-requests: write

# Avoid two runs pushing gh-pages at the same time
concurrency:
  group: pages-previews
  cancel-in-progress: false

jobs:
  generate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: InProcess
            q2: "N"
          - variant: OutOfProcess
            q2: "Y"

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Checkout ThunderInterfaces
        uses: actions/checkout@v4
        with:
          repository: rdkcentral/ThunderInterfaces
          path: ThunderInterfaces

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install PyYAML

      - name: Run PluginSkeletonGenerator
        shell: bash
        env:
          INTERFACES_H: ${{ github.workspace }}/ThunderInterfaces/interfaces/IMath.h
        run: |
          set -euo pipefail
          mkdir -p generated
          cd generated

          printf '%s\n' \
            "${{ matrix.variant }}" \
            "${{ matrix.q2 }}" \
            "N" \
            "${INTERFACES_H}" \
            "" \
            "N" \
            "" \
          | python ../PluginSkeletonGenerator/PluginSkeletonGenerator.py

      - name: Upload generated variant as artifact
        uses: actions/upload-artifact@v4
        with:
          name: PluginSkeleton-${{ matrix.variant }}
          path: generated/${{ matrix.variant }}/
          compression-level: 9

  publish_pages:
    runs-on: ubuntu-latest
    needs: [ generate ]

    # Skip deploy/comment for fork PRs (no write access)
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Download all generated artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Setup Node (for diff2html-cli)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build static preview site (and diff for PRs)
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            DEST_DIR="previews/pr-${{ github.event.pull_request.number }}"
          else
            DEST_DIR="master/latest"
          fi

          export DEST_DIR
          echo "DEST_DIR=$DEST_DIR" >> "$GITHUB_ENV"

          mkdir -p "site/$DEST_DIR"

          # Make sure GitHub Pages serves underscore-prefixed folders like _assets/
          touch site/.nojekyll

          # Copy outputs into Pages structure
          cp -a artifacts/PluginSkeleton-InProcess    "site/$DEST_DIR/InProcess"
          cp -a artifacts/PluginSkeleton-OutOfProcess "site/$DEST_DIR/OutOfProcess"

          # For PRs: generate a baseline from the PR base SHA and create HTML diffs
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Checkout baseline generator code at PR base SHA
            git clone --no-checkout "https://github.com/${{ github.repository }}.git" base_repo
            git -C base_repo checkout --detach "${{ github.event.pull_request.base.sha }}"

            # Same ThunderInterfaces as the PR run uses (checked out here fresh)
            git clone "https://github.com/rdkcentral/ThunderInterfaces.git" ThunderInterfaces

            python -m pip install --upgrade pip
            python -m pip install PyYAML

            INTERFACES_H="${PWD}/ThunderInterfaces/interfaces/IMath.h"

            mkdir -p base_generated
            (
              cd base_generated
              gen() {
                local variant="$1" q2="$2"
                printf '%s\n' "$variant" "$q2" "N" "$INTERFACES_H" "" "N" "" \
                  | python ../base_repo/PluginSkeletonGenerator/PluginSkeletonGenerator.py
              }
              gen InProcess N
              gen OutOfProcess Y
            )

            mkdir -p diffs "site/$DEST_DIR/diff"

            # Directory diffs (don't fail the step if there are differences)
            git diff --no-index -- base_generated/InProcess  artifacts/PluginSkeleton-InProcess   > diffs/InProcess.diff  || true
            git diff --no-index -- base_generated/OutOfProcess artifacts/PluginSkeleton-OutOfProcess > diffs/OutOfProcess.diff || true

            # Render diff -> HTML
            npx --yes diff2html-cli@5.2.15 -i file -F "site/$DEST_DIR/diff/InProcess.html"   -- diffs/InProcess.diff
            npx --yes diff2html-cli@5.2.15 -i file -F "site/$DEST_DIR/diff/OutOfProcess.html" -- diffs/OutOfProcess.diff

            # Also publish raw diffs
            cp -a diffs/*.diff "site/$DEST_DIR/diff/"

            cat > "site/$DEST_DIR/diff/index.html" <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <h1>Generated diff vs PR base (master)</h1>
          <ul>
            <li><a href="./InProcess.html">InProcess (HTML)</a> | <a href="./InProcess.diff">raw diff</a></li>
            <li><a href="./OutOfProcess.html">OutOfProcess (HTML)</a> | <a href="./OutOfProcess.diff">raw diff</a></li>
          </ul>
          HTML
          fi

          # Generate a shared dark CSS and a landing page
          mkdir -p "site/$DEST_DIR/_assets"

          cat > "site/$DEST_DIR/_assets/style.css" <<'CSS'
          :root{
            color-scheme: dark;
            --bg: #0d1117;
            --fg: #c9d1d9;
            --muted: #8b949e;
            --link: #58a6ff;
            --border: #30363d;
            --card: #161b22;
          }
          html,body{height:100%}
          body{
            margin:0;
            font: 18px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
            background:var(--bg);
            color:var(--fg);
          }
          a{color:var(--link);text-decoration:none}
          a:hover{text-decoration:underline}
          .container{max-width:1100px;margin:0 auto;padding:24px}
          .nav{
            display:flex; gap:14px; flex-wrap:wrap;
            padding:14px 24px; border-bottom:1px solid var(--border);
            background:rgba(13,17,23,.92); position:sticky; top:0;
          }
          .nav a{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--card)}
          h1{font-size:28px;margin:18px 0}
          ul{margin:10px 0 0 20px}
          .small{color:var(--muted);font-size:14px}
          CSS

          # Preview landing page (single hub)
          DIFF_ITEM=""
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            DIFF_ITEM='<li><a href="./diff/">Diff vs PR base</a></li>'
          fi

          cat > "site/$DEST_DIR/index.html" <<HTML
          <!doctype html>
          <html>
            <head>
              <meta charset="utf-8">
              <title>PluginSkeletonGenerator preview</title>
              <link rel="stylesheet" href="./_assets/style.css">
            </head>
            <body>
              <div class="nav">
                <a href="./">Preview</a>
                <a href="./InProcess/">InProcess</a>
                <a href="./OutOfProcess/">OutOfProcess</a>
                <a href="./diff/">Diff</a>
              </div>
              <div class="container">
                <h1>PluginSkeletonGenerator output</h1>
                <ul>
                  <li><a href="./InProcess/">Browse InProcess</a></li>
                  <li><a href="./OutOfProcess/">Browse OutOfProcess</a></li>
                  ${DIFF_ITEM}
                </ul>
                <p class="small">
                  Tip: use the nav bar to move between Preview / Outputs / Diff.
                </p>
              </div>
            </body>
          </html>
          HTML

          # Create folder indexes everywhere so browsing directories in Pages doesn't 404
          python - <<'PY'
          from pathlib import Path
          import html, os

          DEST_DIR = os.environ["DEST_DIR"]
          dest_root = Path("site") / DEST_DIR

          def rel_home(dir_path: Path) -> str:
              # Number of path segments from dest_root to this directory
              rel = dir_path.relative_to(dest_root)
              depth = len(rel.parts)
              return "./" if depth == 0 else "../" * depth

          def page(title: str, nav_html: str, body_html: str, css_href: str) -> str:
              return "\n".join([
                  "<!doctype html>",
                  "<html>",
                  "  <head>",
                  "    <meta charset='utf-8'>",
                  f"    <title>{html.escape(title)}</title>",
                  f"    <link rel='stylesheet' href='{html.escape(css_href)}'>",
                  "  </head>",
                  "  <body>",
                  f"    <div class='nav'>{nav_html}</div>",
                  "    <div class='container'>",
                  f"{body_html}",
                  "    </div>",
                  "  </body>",
                  "</html>",
              ])

          def write_index(dir_path: Path):
              home = rel_home(dir_path)
              css_href = f"{home}_assets/style.css"
              diff_link = f"{home}diff/"  # ok if missing on master; link just won't exist
              nav = (
                  f"<a href='{home}'>Preview</a>"
                  f"<a href='{home}InProcess/'>InProcess</a>"
                  f"<a href='{home}OutOfProcess/'>OutOfProcess</a>"
                  f"<a href='{diff_link}'>Diff</a>"
              )

              entries = sorted(dir_path.iterdir(), key=lambda p: (p.is_file(), p.name.lower()))
              items = ["<ul>", f"<li><a href='{home}'>‚üµ Back to preview</a></li>"]
              for p in entries:
                  if p.name == "index.html":
                      continue
                  name = p.name + ("/" if p.is_dir() else "")
                  href = p.name + ("/" if p.is_dir() else "")
                  items.append(f"<li><a href='{html.escape(href)}'>{html.escape(name)}</a></li>")
              items.append("</ul>")

              body = f"<h1>{html.escape(dir_path.name)}</h1>\n" + "\n".join(items)
              (dir_path / "index.html").write_text(page(dir_path.name, nav, body, css_href), encoding="utf-8")

          def walk(root: Path):
              if not root.exists():
                  return
              for d in [root] + [p for p in root.rglob("*") if p.is_dir()]:
                  write_index(d)

          walk(dest_root / "InProcess")
          walk(dest_root / "OutOfProcess")
          walk(dest_root / "diff")
          PY

          # Landing page for this preview
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            DIFF_LINK='<li><a href="./diff/">Diff vs PR base</a></li>'
          else
            DIFF_LINK=''
          fi

          cat > "site/$DEST_DIR/index.html" <<HTML
          <!doctype html>
          <html>
            <head><meta charset="utf-8"><title>PluginSkeletonGenerator output</title></head>
            <body>
              <h1>PluginSkeletonGenerator output</h1>
              <ul>
                <li><a href="./InProcess/">InProcess</a></li>
                <li><a href="./OutOfProcess/">OutOfProcess</a></li>
                ${DIFF_LINK}
              </ul>
            </body>
          </html>
          HTML

          # Root index (nice entry point)
          mkdir -p site
          cat > "site/index.html" <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <h1>ThunderTools PluginSkeletonGenerator previews</h1>
          <ul>
            <li><a href="./master/latest/">master/latest</a></li>
            <li><a href="./previews/">previews/</a></li>
          </ul>
          HTML

      - name: Deploy to gh-pages (keep other previews)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./site
          destination_dir: .
          keep_files: true
      
      - name: Comment PR with Pages link
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Plugin skeleton preview:
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.DEST_DIR }}/
