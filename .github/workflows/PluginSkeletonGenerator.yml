name: Generate Thunder plugin skeletons

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - "PluginSkeletonGenerator/**"
      - ".github/workflows/generate-plugin-skeletons.yml"
  pull_request:
    branches: [ master ]
    paths:
      - "PluginSkeletonGenerator/**"
      - ".github/workflows/generate-plugin-skeletons.yml"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pages-previews
  cancel-in-progress: false

jobs:
  generate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: InProcess
            q2: "N"
          - variant: OutOfProcess
            q2: "Y"

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Checkout ThunderInterfaces
        uses: actions/checkout@v4
        with:
          repository: rdkcentral/ThunderInterfaces
          path: ThunderInterfaces

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install PyYAML

      - name: Run PluginSkeletonGenerator
        shell: bash
        env:
          INTERFACES_H: ${{ github.workspace }}/ThunderInterfaces/interfaces/IMath.h
        run: |
          set -euo pipefail
          mkdir -p generated
          cd generated

          printf '%s\n' \
            "${{ matrix.variant }}" \
            "${{ matrix.q2 }}" \
            "N" \
            "${INTERFACES_H}" \
            "" \
            "N" \
            "" \
          | python ../PluginSkeletonGenerator/PluginSkeletonGenerator.py

      - name: Upload generated variant as artifact
        uses: actions/upload-artifact@v4
        with:
          name: PluginSkeleton-${{ matrix.variant }}
          path: generated/${{ matrix.variant }}/
          compression-level: 9

  publish_pages:
    runs-on: ubuntu-latest
    needs: [ generate ]

    # Skip deploy/comment for fork PRs (no write access)
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Download all generated artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Setup Node (for diff2html-cli)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build static preview site (and diff for PRs)
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            DEST_DIR="previews/pr-${{ github.event.pull_request.number }}"
          else
            DEST_DIR="master/latest"
          fi

          BUILD_ID="${{ github.run_id }}"   # cache-buster token
          export DEST_DIR BUILD_ID
          echo "DEST_DIR=$DEST_DIR" >> "$GITHUB_ENV"
          echo "BUILD_ID=$BUILD_ID" >> "$GITHUB_ENV"

          mkdir -p "site/$DEST_DIR"

          # Disable Jekyll processing (safe default for generated content)
          touch site/.nojekyll

          # Copy outputs into Pages structure
          cp -a artifacts/PluginSkeleton-InProcess     "site/$DEST_DIR/InProcess"
          cp -a artifacts/PluginSkeleton-OutOfProcess  "site/$DEST_DIR/OutOfProcess"

          # ------------------------------------------------------------
          # For PRs: generate baseline from PR base SHA and create diffs
          # ------------------------------------------------------------
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git clone --no-checkout "https://github.com/${{ github.repository }}.git" base_repo
            git -C base_repo checkout --detach "${{ github.event.pull_request.base.sha }}"

            git clone "https://github.com/rdkcentral/ThunderInterfaces.git" ThunderInterfaces
            python -m pip install --upgrade pip
            python -m pip install PyYAML

            INTERFACES_H="${PWD}/ThunderInterfaces/interfaces/IMath.h"

            mkdir -p base_generated
            (
              cd base_generated
              gen() {
                local variant="$1" q2="$2"
                printf '%s\n' "$variant" "$q2" "N" "$INTERFACES_H" "" "N" "" \
                  | python ../base_repo/PluginSkeletonGenerator/PluginSkeletonGenerator.py
              }
              gen InProcess N
              gen OutOfProcess Y
            )

            mkdir -p diffs "site/$DEST_DIR/diff"

            git diff --no-index -- base_generated/InProcess   artifacts/PluginSkeleton-InProcess      > diffs/InProcess.diff   || true
            git diff --no-index -- base_generated/OutOfProcess artifacts/PluginSkeleton-OutOfProcess > diffs/OutOfProcess.diff || true

            npx --yes diff2html-cli@5.2.15 -i file -F "site/$DEST_DIR/diff/InProcess.html"    -- diffs/InProcess.diff
            npx --yes diff2html-cli@5.2.15 -i file -F "site/$DEST_DIR/diff/OutOfProcess.html" -- diffs/OutOfProcess.diff

            # Only publish HTML (no raw .diff files)
            cat > "site/$DEST_DIR/diff/index.html" <<HTML
          <!doctype html>
          <html>
            <head>
              <meta charset="utf-8">
              <title>Diff</title>
              <link rel="stylesheet" href="../assets/style.css?v=${BUILD_ID}">
            </head>
            <body>
              <div class="nav">
                <a href="../?v=${BUILD_ID}">Preview</a>
                <a href="../InProcess/?v=${BUILD_ID}">InProcess</a>
                <a href="../OutOfProcess/?v=${BUILD_ID}">OutOfProcess</a>
                <a href="./?v=${BUILD_ID}">Diff</a>
              </div>
              <div class="container">
                <h1>Generated diff vs PR base (master)</h1>
                <ul>
                  <li><a href="./InProcess.html?v=${BUILD_ID}">InProcess</a></li>
                  <li><a href="./OutOfProcess.html?v=${BUILD_ID}">OutOfProcess</a></li>
                </ul>
              </div>
            </body>
          </html>
          HTML
          fi

          # ------------------------------------------------------------
          # Dark theme CSS (no underscore folder)
          # ------------------------------------------------------------
          mkdir -p "site/$DEST_DIR/assets"
          cat > "site/$DEST_DIR/assets/style.css" <<'CSS'
          :root{
            color-scheme: dark;
            --bg: #0d1117;
            --fg: #c9d1d9;
            --muted: #8b949e;
            --link: #58a6ff;
            --border: #30363d;
            --card: #161b22;
          }
          html,body{height:100%}
          body{
            margin:0;
            font: 18px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
            background:var(--bg);
            color:var(--fg);
          }
          a{color:var(--link);text-decoration:none}
          a:hover{text-decoration:underline}
          .container{max-width:1100px;margin:0 auto;padding:24px}
          .nav{
            display:flex; gap:14px; flex-wrap:wrap;
            padding:14px 24px; border-bottom:1px solid var(--border);
            background:rgba(13,17,23,.92); position:sticky; top:0;
            z-index: 10;
          }
          .nav a{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--card)}
          h1{font-size:28px;margin:18px 0}
          ul{margin:10px 0 0 20px}
          .small{color:var(--muted);font-size:14px}
          CSS

          # ------------------------------------------------------------
          # Hub page for this preview (single entry point)
          # ------------------------------------------------------------
          DIFF_ITEM=""
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            DIFF_ITEM='<li><a href="./diff/?v='"${BUILD_ID}"'">Diff vs PR base</a></li>'
          fi

          cat > "site/$DEST_DIR/index.html" <<HTML
          <!doctype html>
          <html>
            <head>
              <meta charset="utf-8">
              <title>PluginSkeletonGenerator preview</title>
              <link rel="stylesheet" href="./assets/style.css?v=${BUILD_ID}">
              <meta http-equiv="cache-control" content="no-cache">
              <meta http-equiv="pragma" content="no-cache">
              <meta http-equiv="expires" content="0">
            </head>
            <body>
              <div class="nav">
                <a href="./?v=${BUILD_ID}">Preview</a>
                <a href="./InProcess/?v=${BUILD_ID}">InProcess</a>
                <a href="./OutOfProcess/?v=${BUILD_ID}">OutOfProcess</a>
                <a href="./diff/?v=${BUILD_ID}">Diff</a>
              </div>
              <div class="container">
                <h1>PluginSkeletonGenerator output</h1>
                <ul>
                  <li><a href="./InProcess/?v=${BUILD_ID}">Browse InProcess</a></li>
                  <li><a href="./OutOfProcess/?v=${BUILD_ID}">Browse OutOfProcess</a></li>
                  ${DIFF_ITEM}
                </ul>
                <p class="small">If something looks stale, the URL version token forces a fresh fetch.</p>
              </div>
            </body>
          </html>
          HTML

          # ------------------------------------------------------------
          # Generate index.html in every directory + inject nav + CSS (with ?v=BUILD_ID)
          # Also post-process diff2html pages to include nav + themed CSS
          # ------------------------------------------------------------
          python - <<'PY'
          from pathlib import Path
          import html, os, re

          DEST_DIR = os.environ["DEST_DIR"]
          BUILD_ID = os.environ.get("BUILD_ID", "0")
          root = Path("site") / DEST_DIR

          def rel_to_root(dir_path: Path) -> str:
            rel = dir_path.relative_to(root)
            depth = len(rel.parts)
            return "./" if depth == 0 else "../" * depth

          def q() -> str:
            return f"?v={BUILD_ID}"

          def nav(home: str) -> str:
            return (
              f"<a href='{home}{q()}'>Preview</a>"
              f"<a href='{home}InProcess/{q()}'>InProcess</a>"
              f"<a href='{home}OutOfProcess/{q()}'>OutOfProcess</a>"
              f"<a href='{home}diff/{q()}'>Diff</a>"
            )

          def wrap_page(title: str, nav_html: str, body_html: str, css_href: str) -> str:
            return "\n".join([
              "<!doctype html>",
              "<html>",
              "  <head>",
              "    <meta charset='utf-8'>",
              f"    <title>{html.escape(title)}</title>",
              f"    <link rel='stylesheet' href='{html.escape(css_href)}'>",
              "  </head>",
              "  <body>",
              f"    <div class='nav'>{nav_html}</div>",
              "    <div class='container'>",
              f"{body_html}",
              "    </div>",
              "  </body>",
              "</html>",
            ])

          def write_dir_index(dir_path: Path):
            home = rel_to_root(dir_path)
            css_href = f"{home}assets/style.css{q()}"
            nav_html = nav(home)

            entries = sorted(dir_path.iterdir(), key=lambda p: (p.is_file(), p.name.lower()))
            items = ["<ul>", f"<li><a href='{home}{q()}'>‚üµ Back to preview</a></li>"]

            for p in entries:
              if p.name == "index.html":
                continue
              name = p.name + ("/" if p.is_dir() else "")
              href = p.name + ("/" if p.is_dir() else "")

              # Always append cache-buster to keep navigation fresh
              href = href + q()
              items.append(f"<li><a href='{html.escape(href)}'>{html.escape(name)}</a></li>")

            items.append("</ul>")
            body = f"<h1>{html.escape(dir_path.name)}</h1>\n" + "\n".join(items)
            (dir_path / "index.html").write_text(wrap_page(dir_path.name, nav_html, body, css_href), encoding="utf-8")

          def walk_and_index(start: Path):
            if not start.exists():
              return
            for d in [start] + [p for p in start.rglob("*") if p.is_dir()]:
              write_dir_index(d)

          walk_and_index(root / "InProcess")
          walk_and_index(root / "OutOfProcess")
          walk_and_index(root / "diff")

          # Patch diff2html HTML pages (inject our CSS link + nav; add ?v=BUILD_ID)
          for diff_html in [root / "diff" / "InProcess.html", root / "diff" / "OutOfProcess.html"]:
            if not diff_html.exists():
              continue

            home = rel_to_root(diff_html.parent)
            css_href = f"{home}assets/style.css{q()}"
            nav_html = nav(home)

            txt = diff_html.read_text(encoding="utf-8")

            if css_href not in txt:
              txt = re.sub(r"</head>", f"  <link rel='stylesheet' href='{css_href}'>\n</head>", txt, count=1, flags=re.I)

            if "class='nav'" not in txt and 'class="nav"' not in txt:
              txt = re.sub(r"<body[^>]*>", lambda m: m.group(0) + f"\n<div class='nav'>{nav_html}</div>\n<div class='container'>", txt, count=1, flags=re.I)
              txt = re.sub(r"</body>", "</div>\n</body>", txt, count=1, flags=re.I)

            diff_html.write_text(txt, encoding="utf-8")
          PY

          # Root site index (optional)
          cat > "site/index.html" <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <h1>ThunderTools PluginSkeletonGenerator previews</h1>
          <ul>
            <li><a href="./master/latest/">master/latest</a></li>
            <li><a href="./previews/">previews/</a></li>
          </ul>
          HTML

      - name: Deploy to gh-pages (keep other previews)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./site
          destination_dir: .
          keep_files: true

      - name: Comment PR with Pages link (cache-busted)
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Plugin skeleton preview:
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.DEST_DIR }}/?v=${{ env.BUILD_ID }}
