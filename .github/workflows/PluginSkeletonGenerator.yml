name: Generate Thunder plugin skeletons

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - "PluginSkeletonGenerator/**"
      - ".github/workflows/generate-plugin-skeletons.yml"
  pull_request:
    branches: [ master ]
    paths:
      - "PluginSkeletonGenerator/**"
      - ".github/workflows/generate-plugin-skeletons.yml"

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - variant: InProcess
            q2: "N"
          - variant: OutOfProcess
            q2: "Y"

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Checkout ThunderInterfaces
        uses: actions/checkout@v4
        with:
          repository: rdkcentral/ThunderInterfaces
          path: ThunderInterfaces

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install PyYAML

      - name: Run PluginSkeletonGenerator
        shell: bash
        env:
          INTERFACES_H: ${{ github.workspace }}/ThunderInterfaces/interfaces/IMath.h
        run: |
          set -euo pipefail
          mkdir -p generated
          cd generated

          printf '%s\n' \
            "${{ matrix.variant }}" \
            "${{ matrix.q2 }}" \
            "N" \
            "${INTERFACES_H}" \
            "" \
            "N" \
            "" \
          | python ../PluginSkeletonGenerator/PluginSkeletonGenerator.py

      - name: Upload generated variant as artifact
        uses: actions/upload-artifact@v4
        with:
          name: PluginSkeleton-${{ matrix.variant }}
          path: generated/${{ matrix.variant }}/
          compression-level: 9

  publish_pages:
    runs-on: ubuntu-latest
    needs: [ generate ]

    steps:
      - name: Download all generated artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Build static preview site
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            DEST_DIR="previews/pr-${{ github.event.pull_request.number }}"
          else
            DEST_DIR="master/latest"
          fi

          echo "DEST_DIR=$DEST_DIR" >> "$GITHUB_ENV"

          mkdir -p site
          mkdir -p "site/$DEST_DIR"

          cp -a artifacts/PluginSkeleton-InProcess  "site/$DEST_DIR/InProcess"
          cp -a artifacts/PluginSkeleton-OutOfProcess "site/$DEST_DIR/OutOfProcess"

          cat > "site/$DEST_DIR/index.html" <<'HTML'
          <!doctype html>
          <html>
            <head><meta charset="utf-8"><title>PluginSkeletonGenerator output</title></head>
            <body>
              <h1>PluginSkeletonGenerator output</h1>
              <ul>
                <li><a href="./InProcess/">InProcess</a></li>
                <li><a href="./OutOfProcess/">OutOfProcess</a></li>
              </ul>
            </body>
          </html>
          HTML

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./site
          destination_dir: .
          keep_files: true

      - name: Comment PR with Pages link
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Plugin skeleton preview published:
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.DEST_DIR }}/
