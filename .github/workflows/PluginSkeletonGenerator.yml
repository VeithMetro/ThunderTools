name: Generate Thunder plugin skeletons

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - "PluginSkeletonGenerator/**"
      - ".github/workflows/generate-plugin-skeletons.yml"
  pull_request:
    branches: [ master ]
    paths:
      - "PluginSkeletonGenerator/**"
      - ".github/workflows/generate-plugin-skeletons.yml"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pages-previews
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Define generator variants (single source of truth)
        id: set-matrix
        shell: python
        run: |
          import json, os

          # Edit only this list to add/change build types and their answers.
          # Each variant can use a different interface header (e.g. IMath.h vs IBrowser.h).
          #
          # "__INTERFACES_H__" is a placeholder that will be replaced at runtime with:
          #   $GITHUB_WORKSPACE/ThunderInterfaces/interfaces/<header>
          variants = [
            {
              "name": "InProcess",
              "header": "IMath.h",
              "answers": ["InProcess", "N", "N", "__INTERFACES_H__", "", "N", ""],
            },
            {
              "name": "OutOfProcess",
              "header": "IMath.h",
              "answers": ["OutOfProcess", "Y", "N", "__INTERFACES_H__", "", "N", ""],
            },
          ]

          include = []
          for v in variants:
            stdin = "\n".join(v["answers"]) + "\n"
            include.append({"name": v["name"], "header": v["header"], "stdin": stdin})

          matrix = json.dumps({"include": include})
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"matrix={matrix}\n")

  generate:
    runs-on: ubuntu-latest
    needs: [ prepare ]
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.prepare.outputs.matrix) }}

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Checkout ThunderInterfaces
        uses: actions/checkout@v4
        with:
          repository: rdkcentral/ThunderInterfaces
          path: ThunderInterfaces

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install PyYAML

      - name: Run PluginSkeletonGenerator
        shell: bash
        env:
          HEADER: ${{ matrix.header }}
          VARIANT_STDIN: ${{ matrix.stdin }}
        run: |
          set -euo pipefail
          mkdir -p generated
          cd generated

          INTERFACES_H="${GITHUB_WORKSPACE}/ThunderInterfaces/interfaces/${HEADER}"
          STDIN="${VARIANT_STDIN/__INTERFACES_H__/${INTERFACES_H}}"

          printf '%b' "$STDIN" | python ../PluginSkeletonGenerator/PluginSkeletonGenerator.py

      - name: Upload generated variant as artifact
        uses: actions/upload-artifact@v4
        with:
          name: PluginSkeleton-${{ matrix.name }}
          path: generated/${{ matrix.name }}/
          compression-level: 9

  publish_pages:
    runs-on: ubuntu-latest
    needs: [ prepare, generate ]

    # Avoid trying to push to gh-pages / comment when PR comes from a fork.
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Download all generated artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Setup Node (for diff2html-cli)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build static preview site (and diff for PRs)
        shell: bash
        env:
          MATRIX_JSON: ${{ needs.prepare.outputs.matrix }}
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_DIR="previews/pr-${{ github.event.pull_request.number }}"
          else
            BASE_DIR="master"
          fi

          RUN_DIR="${BASE_DIR}/run-${{ github.run_id }}"
          export BASE_DIR RUN_DIR
          echo "BASE_DIR=$BASE_DIR" >> "$GITHUB_ENV"
          echo "RUN_DIR=$RUN_DIR" >> "$GITHUB_ENV"

          mkdir -p "site/$RUN_DIR"

          # Disable Jekyll processing (safe default for generated content).
          touch site/.nojekyll

          # ---- Copy all generated variants (no hard-coded names) ----
          python - <<'PY' > variant_names.txt
          import json, os
          m = json.loads(os.environ["MATRIX_JSON"])
          for item in m["include"]:
            print(item["name"])
          PY

          while read -r name; do
            cp -a "artifacts/PluginSkeleton-${name}" "site/$RUN_DIR/${name}"
          done < variant_names.txt

          # ---- PR-only: baseline generation + diffs (HTML only) ----
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git clone --no-checkout "https://github.com/${{ github.repository }}.git" base_repo
            git -C base_repo checkout --detach "${{ github.event.pull_request.base.sha }}"

            git clone "https://github.com/rdkcentral/ThunderInterfaces.git" ThunderInterfaces
            python -m pip install --upgrade pip
            python -m pip install PyYAML

            mkdir -p base_generated diffs "site/$RUN_DIR/diff"

            python - <<'PY' > variant_stdin.tsv
          import json, os
          m = json.loads(os.environ["MATRIX_JSON"])
          for item in m["include"]:
            # name \t header \t stdin
            print(item["name"] + "\t" + item["header"] + "\t" + item["stdin"])
          PY

            while IFS=$'\t' read -r name header stdin; do
              INTERFACES_H="${PWD}/ThunderInterfaces/interfaces/${header}"

              (
                cd base_generated
                STDIN="${stdin/__INTERFACES_H__/${INTERFACES_H}}"
                printf '%b' "$STDIN" | python ../base_repo/PluginSkeletonGenerator/PluginSkeletonGenerator.py
              )

              git diff --no-index -- "base_generated/$name" "artifacts/PluginSkeleton-$name" > "diffs/$name.diff" || true
              npx --yes diff2html-cli@5.2.15 -i file -F "site/$RUN_DIR/diff/$name.html" -- "diffs/$name.diff"
            done < variant_stdin.tsv
          fi

          # ---- Dark theme CSS ----
          mkdir -p "site/$RUN_DIR/assets"
          cat > "site/$RUN_DIR/assets/style.css" <<'CSS'
          :root{
            color-scheme: dark;
            --bg:#0d1117; --fg:#c9d1d9; --muted:#8b949e; --link:#58a6ff;
            --border:#30363d; --card:#161b22;
          }
          body{margin:0;font:18px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:var(--bg);color:var(--fg)}
          a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
          .container{max-width:1100px;margin:0 auto;padding:24px}
          .nav{display:flex;gap:14px;flex-wrap:wrap;padding:14px 24px;border-bottom:1px solid var(--border);
               background:rgba(13,17,23,.92);position:sticky;top:0;z-index:10}
          .nav a{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--card)}
          h1{font-size:28px;margin:18px 0}
          CSS

          # ---- Build hub + folder indexes + patch diff HTML with nav/CSS ----
          python - <<'PY'
          from pathlib import Path
          import html, json, os, re

          matrix = json.loads(os.environ["MATRIX_JSON"])
          variants = [i["name"] for i in matrix["include"]]

          run_root = Path("site") / os.environ["RUN_DIR"]
          css_root = "./assets/style.css"

          def nav(home: str) -> str:
            links = [f"<a href='{home}'>Preview</a>"]
            for v in variants:
              links.append(f"<a href='{home}{html.escape(v)}/'>{html.escape(v)}</a>")
            links.append(f"<a href='{home}diff/'>Diff</a>")
            return "".join(links)

          def wrap(title: str, home: str, body_html: str, css_href: str) -> str:
            return "\n".join([
              "<!doctype html>",
              "<html><head><meta charset='utf-8'>",
              f"<title>{html.escape(title)}</title>",
              f"<link rel='stylesheet' href='{html.escape(css_href)}'>",
              "</head><body>",
              f"<div class='nav'>{nav(home)}</div>",
              "<div class='container'>",
              body_html,
              "</div></body></html>",
            ])

          # Hub page
          items = ["<h1>PluginSkeletonGenerator output</h1><ul>"]
          for v in variants:
            items.append(f"<li><a href='./{html.escape(v)}/'>Browse {html.escape(v)}</a></li>")
          if (run_root / "diff").exists():
            items.append("<li><a href='./diff/'>Diff vs PR base</a></li>")
          items.append("</ul>")
          (run_root / "index.html").write_text(wrap("Preview", "./", "\n".join(items), css_root), encoding="utf-8")

          def rel_home(dir_path: Path) -> str:
            rel = dir_path.relative_to(run_root)
            depth = len(rel.parts)
            return "./" if depth == 0 else "../" * depth

          def write_dir_index(dir_path: Path):
            home = rel_home(dir_path)
            css_href = f"{home}assets/style.css"
            entries = sorted(dir_path.iterdir(), key=lambda p: (p.is_file(), p.name.lower()))
            lst = ["<h1>%s</h1><ul>" % html.escape(dir_path.name), f"<li><a href='{home}'>‚üµ Back to preview</a></li>"]
            for p in entries:
              if p.name == "index.html":
                continue
              name = p.name + ("/" if p.is_dir() else "")
              href = p.name + ("/" if p.is_dir() else "")
              lst.append(f"<li><a href='{html.escape(href)}'>{html.escape(name)}</a></li>")
            lst.append("</ul>")
            (dir_path / "index.html").write_text(wrap(dir_path.name, home, "\n".join(lst), css_href), encoding="utf-8")

          def walk(root: Path):
            if not root.exists():
              return
            for d in [root] + [p for p in root.rglob("*") if p.is_dir()]:
              write_dir_index(d)

          for v in variants:
            walk(run_root / v)
          walk(run_root / "diff")

          # Diff index (HTML only)
          diff_dir = run_root / "diff"
          if diff_dir.exists():
            home = rel_home(diff_dir)
            css_href = f"{home}assets/style.css"
            body = "<h1>Diff</h1><ul>" + "".join(
              f"<li><a href='./{html.escape(v)}.html'>{html.escape(v)}</a></li>" for v in variants
            ) + "</ul>"
            (diff_dir / "index.html").write_text(wrap("Diff", home, body, css_href), encoding="utf-8")

          # Patch diff2html pages: inject our CSS + nav wrapper
          for v in variants:
            p = diff_dir / f"{v}.html"
            if not p.exists():
              continue
            home = rel_home(p.parent)
            css_href = f"{home}assets/style.css"
            txt = p.read_text(encoding="utf-8")

            if css_href not in txt:
              txt = re.sub(r"</head>", f"  <link rel='stylesheet' href='{css_href}'>\n</head>", txt, count=1, flags=re.I)

            if "class='nav'" not in txt and 'class="nav"' not in txt:
              txt = re.sub(r"<body[^>]*>", lambda m: m.group(0) + f"\n<div class='nav'>{nav(home)}</div>\n<div class='container'>", txt, count=1, flags=re.I)
              txt = re.sub(r"</body>", "</div>\n</body>", txt, count=1, flags=re.I)

            p.write_text(txt, encoding="utf-8")
          PY

          # ---- Stable pointer page: /previews/pr-X/ -> latest run ----
          mkdir -p "site/$BASE_DIR"
          cat > "site/$BASE_DIR/index.html" <<HTML
          <!doctype html>
          <meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=./run-${{ github.run_id }}/">
          <a href="./run-${{ github.run_id }}/">Open latest run</a>
          HTML

          # Optional root index
          cat > "site/index.html" <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <h1>ThunderTools PluginSkeletonGenerator previews</h1>
          <ul>
            <li><a href="./master/">master</a></li>
            <li><a href="./previews/">previews</a></li>
          </ul>
          HTML

      - name: Deploy to gh-pages (keep other previews)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./site
          destination_dir: .
          keep_files: true

      - name: Comment PR with Pages link (run-versioned)
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Plugin skeleton preview (latest run):
            https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.RUN_DIR }}/
