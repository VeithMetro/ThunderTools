name: Generate plugin skeletons

permissions:
  contents: read

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - "PluginSkeletonGenerator/**"
      - ".github/workflows/generate-plugin-skeletons.yml"
  pull_request:
    branches: [ master ]
    paths:
      - "PluginSkeletonGenerator/**"
      - ".github/workflows/generate-plugin-skeletons.yml"

jobs:
  generate:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          - variant: InProcess
            q2: "N"
          - variant: OutOfProcess
            q2: "Y"

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install PyYAML

      - name: Checkout ThunderTools
        uses: actions/checkout@v4
        with:
          path: ThunderTools
          repository: rdkcentral/ThunderTools

      - name: Checkout ThunderInterfaces
        uses: actions/checkout@v4
        with:
          path: ThunderInterfaces
          repository: rdkcentral/ThunderInterfaces

      - name: Run PluginSkeletonGenerator
        shell: bash
        env:
          INTERFACES_H: ${{ github.workspace }}/ThunderInterfaces/interfaces/IMath.h
        run: |
          set -euo pipefail
          mkdir -p generated
          cd generated
          printf '%s\n' \
            "${{ matrix.variant }}" \
            "${{ matrix.q2 }}" \
            "N" \
            "${INTERFACES_H}" \
            "" \
            "N" \
            "" \
          | python ../ThunderTools/PluginSkeletonGenerator/PluginSkeletonGenerator.py

      - name: Upload generated plugin skeleton
        uses: actions/upload-artifact@v4
        with:
          name: PluginSkeleton-${{ matrix.variant }}
          path: generated/${{ matrix.variant }}/
